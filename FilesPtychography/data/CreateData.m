%%  Create synthetic data for the Ptychography experiments.
% Run this script to generate the random data for the experiment.

% NOTE: We used the transmission matrix model of a working ptychography 
% system in our experiments. However, due to the restrictions on sharing  
% data, this script uses a synthetic model instead. Hence, the results will  
% be different than the ones in Figure 7.4 and Figure SM6.2 in our paper. 
% We generate the synthetic model by randomly drawing the complex 
% coefficients of the transmission matrix (with unit magnitude and
% i.i.d. random phase angle chosen uniformly over -pi to pi.) 

rng(0,'twister') % fix the random seed

for dim = [160,320,640]

num_im = 225;
[p1,p2,mask_width] = positions(dim);

n = (dim+1)^2;
J = [];

for  ell = 1 : num_im
    NN = combvec(p1(ell):(p1(ell)+mask_width-1), p2(ell):(p2(ell)+mask_width-1));
    J = [J, sub2ind([dim+1,dim+1],NN(1,:),NN(2,:))]; %#ok
end

d = numel(J);
ANGLES = (rand(d,1) - 0.5)*(2*pi);
VALS = cos(ANGLES) + 1i*sin(ANGLES);

A = sparse(1:d,J,VALS,d,n);

save(['SyntheticTrMat',num2str(dim),'.mat'],'A','mask_width','num_im');

end


function [p1,p2,mw] = positions(dim)
% p1: Mask positions in the x axis
% p2: Mask positions in the y axis
% mw: Mask width

switch dim 
    case 160
        p1 = [23,22,23,22,22,22,22,22,22,23,23,23,23,22,25,28,30,28,29,28,28,27,28,28,28,28,27,29,31,31,35,34,34,31,34,34,34,33,33,34,34,34,34,36,35,40,43,38,40,39,42,39,40,40,39,39,38,39,40,42,47,48,47,45,45,46,45,47,48,46,47,47,49,45,47,55,54,54,53,54,49,50,53,51,52,55,53,52,51,53,59,58,60,60,58,58,59,61,58,60,59,61,57,57,60,67,63,65,67,67,65,67,66,65,66,66,68,65,67,65,73,73,72,71,71,73,71,71,73,70,72,71,73,71,71,77,78,78,78,77,78,78,78,78,80,79,80,79,77,77,84,82,86,83,85,86,87,85,86,85,85,86,84,83,84,91,89,91,90,92,92,91,90,93,89,91,93,90,91,90,96,97,96,97,95,96,99,99,96,97,98,99,99,97,97,100,100,103,102,103,102,105,102,105,104,104,103,102,101,102,107,108,105,109,109,108,108,109,108,109,109,109,107,108,105];
        p2 = [25,28,35,40,47,51,58,64,73,78,87,89,95,104,107,22,29,35,40,47,54,58,65,73,78,84,90,96,101,107,24,27,35,40,47,53,60,66,71,79,85,90,96,103,108,23,27,34,40,46,52,60,65,72,77,86,90,95,102,108,22,29,35,40,44,51,61,64,73,78,85,89,97,102,107,22,28,33,40,47,52,57,63,73,78,85,92,97,103,109,22,27,32,40,44,52,59,65,73,78,85,90,97,103,109,22,26,34,41,46,51,59,65,73,77,86,91,96,105,109,22,27,33,40,45,53,59,65,71,79,86,91,96,104,108,22,28,34,39,47,52,59,65,72,80,85,91,97,103,109,23,28,33,38,45,53,59,63,72,79,84,91,96,103,109,22,29,34,38,46,52,58,64,72,78,84,91,97,102,109,23,29,34,42,45,51,59,65,72,79,84,90,100,102,109,22,27,35,40,47,53,60,64,72,80,83,89,97,104,107,24,28,34,41,46,54,58,66,73,81,85,90,96,102,106];
        mw = 32;
    case 320
        p1 = [49,44,44,42,43,42,42,43,42,42,45,42,43,46,47,58,56,54,56,54,53,53,52,53,54,54,54,56,57,57,69,69,67,65,67,66,66,65,64,67,66,65,66,68,70,79,81,80,79,79,79,77,79,79,79,78,80,80,80,79,93,90,92,91,89,91,91,90,91,89,91,91,90,92,92,105,103,103,106,104,103,102,102,104,105,103,104,105,103,106,117,117,117,115,116,115,116,116,116,116,117,118,117,118,117,128,128,130,130,129,131,131,129,130,129,130,128,129,128,128,143,142,142,144,142,144,142,144,143,143,142,140,142,143,141,155,154,156,155,156,155,157,156,155,156,156,157,153,155,154,168,167,168,169,167,169,170,169,169,170,168,166,168,166,168,180,179,181,178,180,181,181,181,180,182,183,179,182,178,179,192,191,193,193,192,194,194,195,193,192,194,192,194,191,191,203,202,203,204,204,205,205,206,204,204,205,204,205,203,202,212,214,216,217,215,216,217,216,217,217,216,216,214,213,212];
        p2 = [48,57,68,81,92,105,119,130,142,154,166,179,191,203,212,45,57,68,80,92,104,118,130,142,154,166,179,191,203,214,45,55,68,79,91,103,117,127,142,154,168,182,193,204,215,43,55,66,77,91,103,115,130,141,153,166,182,192,204,215,42,55,67,78,91,103,115,130,143,155,166,182,191,205,217,42,54,67,79,89,102,118,127,141,155,167,181,191,204,216,42,53,64,79,90,102,118,128,143,155,169,180,192,205,216,42,54,66,78,91,104,116,130,143,157,169,182,196,203,217,43,52,65,79,89,103,116,129,143,154,168,181,193,205,217,42,54,64,79,88,103,116,129,142,158,168,181,193,205,215,44,54,66,78,89,101,116,129,140,153,168,179,193,204,216,44,55,67,78,91,103,115,129,143,155,167,181,192,204,216,45,54,68,79,90,104,117,128,143,155,169,179,190,204,215,44,57,68,80,90,104,117,130,143,155,167,178,192,201,214,45,57,68,79,91,106,116,130,141,153,165,178,191,203,213];
        mw = 64; 
    case 640
        p1 = [88,88,89,85,84,82,82,83,83,83,82,85,88,88,90,115,112,110,107,107,105,107,105,107,108,108,111,110,112,111,134,136,130,130,130,129,128,129,129,132,131,131,132,135,133,158,159,157,157,154,154,154,155,152,155,155,157,159,160,159,183,183,181,180,181,179,179,179,181,179,179,180,183,181,184,208,207,204,206,205,203,205,207,206,206,207,208,206,208,209,231,233,233,232,232,231,230,232,231,231,231,233,233,231,233,256,259,257,257,256,258,256,257,257,258,256,258,255,256,258,283,283,284,283,284,285,285,283,283,284,286,282,283,282,283,307,308,309,309,309,309,312,310,309,310,309,310,309,309,307,333,333,334,333,336,334,336,335,336,336,336,333,334,333,331,355,356,360,359,359,360,361,361,362,361,361,356,358,357,355,379,383,382,384,385,383,388,385,386,384,384,385,384,380,380,405,405,406,407,406,409,409,408,410,409,408,407,408,403,402,423,426,429,429,431,432,433,432,431,433,432,430,429,426,425];
        p2 = [90,111,135,162,185,207,232,257,281,307,333,355,377,401,423,88,110,134,157,181,207,230,259,283,307,334,357,381,402,424,88,108,132,157,181,206,233,257,282,308,335,358,381,405,428,86,106,131,156,180,207,231,257,283,309,335,359,383,407,429,83,106,131,155,179,204,231,257,281,308,336,359,383,410,431,85,106,129,154,179,207,231,259,281,310,335,358,385,407,432,82,104,129,153,179,204,230,256,282,311,336,362,384,409,432,82,105,129,155,179,205,231,257,285,308,337,362,385,408,432,83,105,128,157,179,205,232,257,286,309,337,363,386,410,432,83,107,130,153,179,205,231,256,284,309,333,360,385,409,432,84,106,131,154,178,204,233,256,282,307,334,360,384,409,431,85,109,130,154,180,207,232,256,284,309,336,360,384,407,432,85,108,131,157,182,207,234,255,283,308,335,357,383,407,428,90,110,134,157,181,207,231,255,282,308,332,358,382,403,426,90,112,136,158,184,206,232,257,283,307,333,355,379,402,422];
        mw = 128;
end
    
end

%% Last edit: Alp Yurtsever - December 06, 2019